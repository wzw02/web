name: CD - Deploy to Production

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to Production
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        # 进入项目目录
        cd /opt/web-calculator
        
        # 拉取最新代码
        git pull origin main
        
        # 拉取最新镜像（假设镜像已推送到Registry）
        docker-compose pull
        
        # 蓝绿部署切换
        CURRENT_ACTIVE=$(docker-compose ps -q app_blue | wc -l)
        if [ $CURRENT_ACTIVE -eq 1 ]; then
          echo "Switching from blue to green"
          docker-compose up -d app_green
          sleep 30
          docker-compose stop app_blue
        else
          echo "Switching from green to blue"
          docker-compose up -d app_blue
          sleep 30
          docker-compose stop app_green
        fi
        
        # 清理旧镜像
        docker image prune -f
        
        echo "Deployment completed successfully!"
        EOF
