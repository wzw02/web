name: CD - Deploy to Production

on:
  push:
    branches: [main]
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Log in to Container Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
  
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to server
      env:
        CURRENT_VERSION: ${{ github.sha }}
        BLUE_COLOR: ${{ secrets.BLUE_COLOR }}
        GREEN_COLOR: ${{ secrets.GREEN_COLOR }}
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
        # 切换到项目目录
        cd /opt/web-calculator
        
        # 拉取最新代码
        git pull origin main
        
        # 登录到容器仓库
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        
        # 确定当前活跃版本和待部署版本
        if [ "$(docker-compose ps -q app_blue | wc -l)" -eq 0 ]; then
          ACTIVE="green"
          NEW="blue"
        else
          ACTIVE="blue"
          NEW="green"
        fi
        
        # 拉取新版本镜像
        docker-compose pull app_$NEW
        
        # 启动新版本容器
        export ${NEW^^}_COLOR=${{ github.sha:0:7 }}
        docker-compose up -d app_$NEW
        
        # 等待新版本健康检查通过
        echo "Waiting for $NEW to become healthy..."
        timeout 120 bash -c "until docker-compose exec -T app_$NEW curl -f http://localhost:5000/health; do sleep 5; done"
        
        # 切换流量到新版本
        echo "Switching traffic to $NEW..."
        # 这里可以调用应用内的切换端点或更新Nginx配置
        
        # 停止旧版本
        docker-compose stop app_$ACTIVE
        
        # 清理旧镜像
        docker image prune -f
        
        echo "Deployment completed! Active version: $NEW"
        EOF
