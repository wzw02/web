name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # 允许手动触发

jobs:
  # CI部分 - 在GitHub托管的运行器上运行
  ci:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        pip install Flask==2.3.3 pytest pytest-cov
    
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v --cov=. --cov-report=xml
    
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
    
    - name: Build Docker image
      run: |
        docker build -t web-calculator:${{ github.sha }} .
    
    - name: Test Docker container
      run: |
        docker run -d --name test-container -p 5000:5000 web-calculator:${{ github.sha }}
        sleep 10
        
        # 使用Python测试容器
        python3 -c "
        import requests
        import time
        import sys
        
        for i in range(10):
            try:
                r = requests.get('http://localhost:5000/health', timeout=5)
                if r.status_code == 200:
                    print('Health check passed')
                    break
            except:
                if i == 9:
                    print('Health check failed')
                    sys.exit(1)
                time.sleep(2)
        
        r = requests.get('http://localhost:5000/add/2&3', timeout=5)
        if r.status_code != 200:
            print('Add endpoint failed')
            sys.exit(1)
        "
        
        docker stop test-container
        docker rm test-container
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: application-code
        path: |
          .
          !.git/
        retention-days: 1

  # CD部分 - 在自托管运行器上运行（仅当push到main分支时）
  deploy:
    runs-on: [self-hosted, linux, x64]  # 使用自托管运行器
    needs: ci  # 依赖于CI任务成功
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: application-code
        path: .
    
    - name: Setup environment
      run: |
        echo "Setting up deployment environment..."
        echo "Running on: $(uname -a)"
        echo "Current directory: $(pwd)"
        echo "Git SHA: ${{ github.sha }}"
    
    - name: Build Docker image locally
      run: |
        echo "Building Docker image..."
        docker build -t web-calculator:${{ github.sha }} .
        docker tag web-calculator:${{ github.sha }} web-calculator:latest
    
    - name: Deploy with Docker Compose (Blue-Green)
      run: |
        # 创建项目目录结构
        mkdir -p /opt/web-calculator/nginx/conf.d
        mkdir -p /opt/web-calculator/data
        
        # 复制必要的文件到部署目录
        cp -r . /opt/web-calculator/source/
        cd /opt/web-calculator
        
        # 创建docker-compose.yml
        cat > docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          nginx:
            image: nginx:alpine
            ports:
              - "80:80"
              - "443:443"
            volumes:
              - ./nginx/conf.d:/etc/nginx/conf.d
              - ./nginx/ssl:/etc/nginx/ssl
            depends_on:
              app_blue:
                condition: service_healthy
              app_green:
                condition: service_healthy
            networks:
              - app_network
            restart: unless-stopped
        
          app_blue:
            image: web-calculator:latest
            container_name: app_blue
            environment:
              - FLASK_ENV=production
              - APP_VERSION=blue-${{ github.sha }}
            healthcheck:
              test: ["CMD", "python", "-c", "import requests; r = requests.get('http://localhost:5000/health'); exit(0 if r.status_code == 200 else 1)"]
              interval: 10s
              timeout: 5s
              retries: 3
              start_period: 30s
            networks:
              - app_network
            restart: on-failure
            volumes:
              - ./data:/app/data
        
          app_green:
            image: web-calculator:latest
            container_name: app_green
            environment:
              - FLASK_ENV=production
              - APP_VERSION=green-${{ github.sha }}
            healthcheck:
              test: ["CMD", "python", "-c", "import requests; r = requests.get('http://localhost:5000/health'); exit(0 if r.status_code == 200 else 1)"]
              interval: 10s
              timeout: 5s
              retries: 3
              start_period: 30s
            networks:
              - app_network
            restart: on-failure
            volumes:
              - ./data:/app/data
        
        networks:
          app_network:
            driver: bridge
        EOF
        
        # 创建nginx配置
        cat > nginx/conf.d/default.conf << 'EOF'
        upstream backend {
            least_conn;
            server app_blue:5000 max_fails=3 fail_timeout=30s;
            server app_green:5000 max_fails=3 fail_timeout=30s;
        }
        
        server {
            listen 80;
            server_name _;
            
            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;
            
            location / {
                proxy_pass http://backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                
                proxy_connect_timeout 5s;
                proxy_send_timeout 60s;
                proxy_read_timeout 60s;
            }
            
            location /health {
                proxy_pass http://backend;
                access_log off;
            }
            
            location /version {
                proxy_pass http://backend;
            }
        }
        EOF
        
        # 检查当前哪个版本是活跃的
        echo "Checking current deployment status..."
        
        BLUE_STATUS=$(docker inspect -f '{{.State.Status}}' app_blue 2>/dev/null || echo "not_running")
        GREEN_STATUS=$(docker inspect -f '{{.State.Status}}' app_blue 2>/dev/null || echo "not_running")
        
        if [[ "$BLUE_STATUS" == "running" ]]; then
          CURRENT_ACTIVE="blue"
          NEW_VERSION="green"
        elif [[ "$GREEN_STATUS" == "running" ]]; then
          CURRENT_ACTIVE="green"
          NEW_VERSION="blue"
        else
          # 如果都没有运行，则从blue开始
          CURRENT_ACTIVE="none"
          NEW_VERSION="blue"
        fi
        
        echo "Current active: $CURRENT_ACTIVE"
        echo "Deploying to: $NEW_VERSION"
        
        # 停止并删除新版本的容器（如果存在）
        docker-compose stop app_$NEW_VERSION 2>/dev/null || true
        docker-compose rm -f app_$NEW_VERSION 2>/dev/null || true
        
        # 启动新版本
        echo "Starting $NEW_VERSION version..."
        docker-compose up -d app_$NEW_VERSION
        
        # 等待新版本健康检查通过
        echo "Waiting for $NEW_VERSION to be healthy..."
        for i in {1..30}; do
          if docker-compose exec -T app_$NEW_VERSION python -c "
          import requests
          try:
              r = requests.get('http://localhost:5000/health', timeout=2)
              exit(0 if r.status_code == 200 else 1)
          except:
              exit(1)
          " 2>/dev/null; then
            echo "$NEW_VERSION is healthy!"
            break
          fi
          
          if [ $i -eq 30 ]; then
            echo "ERROR: $NEW_VERSION failed to become healthy in 60 seconds"
            echo "Rolling back..."
            docker-compose stop app_$NEW_VERSION
            exit 1
          fi
          
          echo "Waiting... ($i/30)"
          sleep 2
        done
        
        # 停止旧版本（如果存在）
        if [[ "$CURRENT_ACTIVE" != "none" ]]; then
          echo "Stopping old version ($CURRENT_ACTIVE)..."
          docker-compose stop app_$CURRENT_ACTIVE
        fi
        
        # 清理旧镜像
        echo "Cleaning up old Docker images..."
        docker image prune -f
        
        # 验证部署
        echo "Verifying deployment..."
        sleep 5
        
        # 创建一个简单的Python脚本来验证所有端点
        cat > verify_deployment.py << 'PYEOF'
        import requests
        import sys
        
        endpoints = [
            ("http://localhost/health", 200),
            ("http://localhost/add/5&3", 200),
            ("http://localhost/multiply/4&6", 200),
            ("http://localhost/subtract/10&4", 200),
            ("http://localhost/divide/20&5", 200),
        ]
        
        all_passed = True
        
        for url, expected_status in endpoints:
            try:
                response = requests.get(url, timeout=5)
                if response.status_code == expected_status:
                    print(f"✓ {url} - {response.status_code}")
                else:
                    print(f"✗ {url} - Expected {expected_status}, got {response.status_code}")
                    all_passed = False
            except Exception as e:
                print(f"✗ {url} - Error: {e}")
                all_passed = False
        
        if all_passed:
            print("✓ All tests passed!")
            sys.exit(0)
        else:
            print("✗ Some tests failed!")
            sys.exit(1)
        PYEOF
        
        python3 verify_deployment.py
        
        echo "Deployment completed successfully!"
        echo "Application is running at: http://$(hostname -I | awk '{print $1}')"
    
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo " Deployment successful!"
          echo "::notice title=Deployment Successful::Application deployed successfully"
        else
          echo " Deployment failed!"
          echo "::error title=Deployment Failed::Deployment failed. Check logs for details."
        fi